
<app-admin-navbar></app-admin-navbar>

<div class="container-fluid">
  <div class="row">
    <!-- SIDEBAR -->
    <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <app-admin-sidebar></app-admin-sidebar>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Editar Adicional</h1>
        <a routerLink="/admin/adicionales" class="btn btn-secondary">
          <i class="bi bi-arrow-left me-2"></i>Volver a Adicionales
        </a>
      </div>

      <!-- ALERTAS -->
      @if (successMessage()) {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <span>{{ successMessage() }}</span>
          <button type="button" class="btn-close" (click)="successMessage.set('')"></button>
        </div>
      }
      @if (errorMessage()) {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <span>{{ errorMessage() }}</span>
          <button type="button" class="btn-close" (click)="errorMessage.set('')"></button>
        </div>
      }

      <!-- FORMULARIO DE EDICIÓN -->
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Datos del Adicional</h5>
            </div>
            <div class="card-body">
              <form (ngSubmit)="updateAdicional()">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="nombre" class="form-label">Nombre del Adicional:</label>
                      <input type="text" class="form-control" id="nombre" 
                             [value]="adicional().nombre"
                             (input)="updateField('nombre', $any($event.target).value)"
                             required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="precioVenta" class="form-label">Precio de Venta:</label>
                      <input type="number" step="0.01" class="form-control" id="precioVenta" 
                             [value]="adicional().precioDeVenta ?? adicional().precio"
                             (input)="updateField('precioDeVenta', +$any($event.target).value)"
                             required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="precioAdquisicion" class="form-label">Precio de Adquisición:</label>
                      <input type="number" step="0.01" class="form-control" id="precioAdquisicion" 
                             [value]="adicional().precioDeAdquisicion"
                             (input)="updateField('precioDeAdquisicion', +$any($event.target).value)">
                    </div>
                  </div>
                </div>
                
                <div class="mb-3">
                  <label for="descripcion" class="form-label">Descripción:</label>
                  <textarea class="form-control" id="descripcion" rows="3"
                            [value]="adicional().descripcion"
                            (input)="updateField('descripcion', $any($event.target).value)"></textarea>
                </div>
                
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="disponible"
                           [checked]="adicional().disponible"
                           (change)="updateField('disponible', $any($event.target).checked)">
                    <label class="form-check-label" for="disponible">
                      Adicional disponible
                    </label>
                  </div>
                </div>

                <!-- SECCIÓN DE PRODUCTOS ASOCIADOS - COMPACTA -->
                @if (adicional().id) {
                  <div class="mb-4">
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h6 class="mb-0">
                        <i class="bi bi-box-seam me-2 text-primary"></i>
                        Productos Asociados
                      </h6>
                      <button type="button" class="btn btn-sm btn-outline-secondary" 
                              (click)="refreshProductosData()"
                              title="Refrescar datos">
                        <i class="bi bi-arrow-clockwise"></i>
                      </button>
                    </div>
                    
                    <div class="row">
                      <!-- Productos asociados actuales -->
                      <div class="col-md-6 mb-3">
                        <label class="form-label text-muted small">PRODUCTOS ASOCIADOS ({{ productosAsociados().length }})</label>
                        <div class="productos-container p-2">
                          @if (productosAsociados().length > 0) {
                            @for (relacion of productosAsociados(); track relacion.id) {
                              <div class="producto-item d-flex justify-content-between align-items-center py-1 px-2 rounded">
                                <span class="text-dark small">{{ getNombreProducto(relacion.productoId!) }}</span>
                                <button type="button" class="btn btn-sm btn-outline-danger p-1"
                                        (click)="desasociarProducto(relacion.productoId!)"
                                        title="Desasociar">
                                  <i class="bi bi-x"></i>
                                </button>
                              </div>
                            }
                          } @else {
                            <div class="text-center estado-vacio py-2">
                              <i class="bi bi-inbox"></i> Sin productos asociados
                            </div>
                          }
                        </div>
                      </div>

                      <!-- Productos disponibles para asociar -->
                      <div class="col-md-6 mb-3">
                        <label class="form-label text-muted small">PRODUCTOS DISPONIBLES ({{ productosDisponibles().length }})</label>
                        <div class="productos-container p-2">
                          @if (productosDisponibles().length > 0) {
                            @for (producto of productosDisponibles(); track producto.id) {
                              <div class="producto-item d-flex justify-content-between align-items-center py-1 px-2 rounded">
                                <span class="text-dark small">{{ producto.nombre }}</span>
                                <button type="button" class="btn btn-sm btn-outline-success p-1"
                                        (click)="asociarProducto(producto.id!)"
                                        title="Asociar">
                                  <i class="bi bi-plus"></i>
                                </button>
                              </div>
                            }
                          } @else {
                            <div class="text-center estado-vacio py-2">
                              <i class="bi bi-check-circle"></i> Todos asociados
                            </div>
                          }
                        </div>
                      </div>
                    </div>

                    <!-- Resumen rápido -->
                    <div class="row">
                      <div class="col-12">
                        <div class="resumen-rapido d-flex justify-content-center gap-4 py-2 rounded">
                          <small>
                            <i class="bi bi-boxes text-primary"></i> 
                            Total: {{ productos().length }}
                          </small>
                          <small>
                            <i class="bi bi-check-circle text-success"></i> 
                            Asociados: {{ productosAsociados().length }}
                          </small>
                          <small>
                            <i class="bi bi-clock text-warning"></i> 
                            Disponibles: {{ productosDisponibles().length }}
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                } @else {
                  <div class="mb-3">
                    <div class="alert alert-info py-2">
                      <small>
                        <i class="bi bi-info-circle me-2"></i>
                        Guarda el adicional para gestionar productos asociados
                      </small>
                    </div>
                  </div>
                }
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <a routerLink="/admin/adicionales" class="btn btn-secondary me-md-2">Cancelar</a>
                  <button type="submit" class="btn btn-info">
                    <i class="bi bi-save me-2"></i>Guardar Cambios
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>


    </main>
  </div>
</div>
