<div class="taco-builder-container">
    <div class="header">
        <h1>Crea Tu Taco Personalizado</h1>
        <p class="subtitle">Arrastra los ingredientes para construir tu taco perfecto</p>
    </div>

    <div class="builder-wrapper">
        <!-- Columna izquierda: Ingredientes + Resumen -->
        <div class="left-column">
            <!-- Panel de ingredientes disponibles -->
            <div class="ingredients-panel">
                <div class="panel-header">
                    <h2>Ingredientes Disponibles</h2>
                    <span class="step-indicator">{{currentStep()}}</span>
                </div>

                <!-- Botones de navegaci√≥n entre categor√≠as -->
                <div class="step-navigation">
                    <button 
                        class="nav-btn btn-prev" 
                        (click)="goToPreviousStep()"
                        [disabled]="currentStep() === 'tortilla'">
                        ‚Üê Anterior
                    </button>
                    <div class="step-info">
                        @if(currentStep() === 'tortilla') {
                            <span>Elige 1 tortilla</span>
                        } @else if(currentStep() === 'prote√≠na') {
                            <span>Elige prote√≠na(s)</span>
                        } @else if(currentStep() === 'salsa') {
                            <span>Elige salsa(s)</span>
                        } @else {
                            <span>Agrega extras (opcional)</span>
                        }
                    </div>
                    <button 
                        class="nav-btn btn-next" 
                        (click)="goToNextStep()"
                        [disabled]="!canGoToNextStep() || currentStep() === 'extras'">
                        Siguiente ‚Üí
                    </button>
                </div>

                <div
                    cdkDropList
                    id="todoList"
                    #todoList="cdkDropList"
                    [cdkDropListConnectedTo]="[doneList]"
                    [cdkDropListData]="todo()"
                    class="ingredients-list"
                    (cdkDropListDropped)="drop($event)">
                    @for(item of todo(); track item.idAdcional) {
                        <div class="ingredient-card" cdkDrag>
                            <div class="ingredient-content">
                                <div class="ingredient-icon">üç¥</div>
                                <div class="ingredient-info">
                                    <h3>{{item.nombre}}</h3>
                                    <span class="price">${{item.precio}}</span>
                                </div>
                            </div>
                            <div class="drag-indicator">‚ãÆ‚ãÆ</div>
                        </div>
                    }
                    @if(todo().length === 0 && currentStep() === 'tortilla') {
                        <div class="empty-message">
                            <p>‚ú® Ya seleccionaste tu tortilla</p>
                        </div>
                    }
                    @if(currentStep() !== 'tortilla') {
                        <div class="info-message">
                            <p>üí° Puedes agregar varios ingredientes de esta categor√≠a</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Panel de Resumen -->
            <div class="summary-panel">
                <div class="panel-header">
                    <h2>Resumen del Pedido</h2>
                    <span class="total-price">Total: ${{totalPrice()}}</span>
                </div>
                <div class="summary-content">
                    @if(done().length === 0) {
                        <div class="empty-summary">
                            <p style="color: #ff6b35;">A√∫n no has agregado ingredientes</p>
                        </div>
                    } @else {
                        <div class="summary-list">
                            @for(item of done(); track item.idAdcional) {
                                <div class="summary-item">
                                    <span class="summary-item-name">‚Ä¢ {{item.nombre}}</span>
                                    <span class="summary-item-price">${{(item.precio || 0) * (item.cantidad || 1)}}</span>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Panel del taco en construcci√≥n -->
        <div class="taco-panel">
            <div class="panel-header">
                <h2>Tu Taco</h2>
            </div>
            <div
                cdkDropList
                cdkDropListSortingDisabled
                id="doneList"
                #doneList="cdkDropList"
                [cdkDropListConnectedTo]="[todoList]"
                [cdkDropListData]="done()"
                class="taco-list"
                (cdkDropListDropped)="drop($event)">
                @if(done().length === 0) {
                    <div class="empty-taco">
                        <div class="taco-icon">üåÆ</div>
                        <p>Arrastra ingredientes aqu√≠ para comenzar</p>
                        <p class="hint">Empieza con una tortilla</p>
                    </div>
                } @else {
                    <div class="taco-visual-container">
                        <!-- Ingredientes apilados (sin salsas) -->
                        <div class="taco-stacked-ingredients">
                            @for(item of done(); track item.idAdcional; let idx = $index) {
                                @if(item.nombre && !item.nombre.toLowerCase().includes('salsa') && !item.nombre.toLowerCase().includes('pico')) {
                                    <div class="stacked-item" [class.tortilla-item]="idx === 0" cdkDrag>
                                        <img [src]="item.image" [alt]="item.nombre" class="ingredient-image">
                                        <div class="item-label">
                                            <span class="item-name">{{item.nombre}}</span>
                                        </div>
                                    </div>
                                }
                            }
                        </div>

                        <!-- Salsas en la parte inferior -->
                        @if(getSalsas().length > 0) {
                            <div class="salsas-section">
                                <h3 class="salsas-section-title">Salsas:</h3>
                                <div class="salsas-display">
                                    @for(salsa of getSalsas(); track salsa.idAdcional) {
                                        <div class="salsa-display-item">
                                            <img [src]="salsa.image" [alt]="salsa.nombre" class="salsa-display-image">
                                            <span class="salsa-display-name">{{salsa.nombre}}</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
            
            <!-- Mensajes de estado -->
            @if(error()) {
                <div class="alert alert-error">
                    {{ error() }}
                </div>
            }
            @if(successMessage()) {
                <div class="alert alert-success">
                    {{ successMessage() }}
                </div>
            }

            @if(done().length > 0) {
                <div class="action-buttons">
                    <button 
                        class="btn-primary" 
                        (click)="agregarAlCarrito()"
                        [disabled]="!puedeAgregarAlCarrito || loading()">
                        @if(loading()) {
                            <span>Agregando...</span>
                        } @else {
                            <span>Agregar al Carrito</span>
                        }
                    </button>
                    <button class="btn-secondary" (click)="clearTaco()" [disabled]="loading()">Limpiar</button>
                    <button class="btn-cancel" (click)="cancelar()" [disabled]="loading()">Cancelar</button>
                </div>
            } @else {
                <div class="action-buttons">
                    <button class="btn-cancel" (click)="cancelar()">Volver a la Tienda</button>
                </div>
            }
        </div>
    </div>
</div>
