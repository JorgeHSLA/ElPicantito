<div class="taco-builder-container">
    <div class="header">
        <h1>Crea Tu Taco Personalizado</h1>
        <p class="subtitle">Arrastra los ingredientes para construir tu taco perfecto</p>
    </div>

    <div class="builder-wrapper">
        <!-- Columna izquierda: Ingredientes -->
        <div class="left-column">
            <!-- Panel de ingredientes disponibles -->
            <div class="ingredients-panel">
                <div class="panel-header">
                    <h2>Ingredientes Disponibles</h2>
                    <span class="step-indicator">{{currentStep()}}</span>
                </div>

                <!-- Botones de navegaci√≥n entre categor√≠as -->
                <div class="step-navigation">
                    <button 
                        class="nav-btn btn-prev" 
                        (click)="goToPreviousStep()"
                        [disabled]="currentStep() === 'tortilla'">
                        ‚Üê Anterior
                    </button>
                    <div class="step-info">
                        @if(currentStep() === 'tortilla') {
                            <span>Elige 1 tortilla</span>
                        } @else if(currentStep() === 'prote√≠na') {
                            <span>Elige prote√≠na(s)</span>
                        } @else if(currentStep() === 'salsa') {
                            <span>Elige salsa(s)</span>
                        } @else {
                            <span>Agrega extras (opcional)</span>
                        }
                    </div>
                    <button 
                        class="nav-btn btn-next" 
                        (click)="goToNextStep()"
                        [disabled]="!canGoToNextStep() || currentStep() === 'salsa'">
                        Siguiente ‚Üí
                    </button>
                </div>

                <div
                    cdkDropList
                    id="todoList"
                    #todoList="cdkDropList"
                    [cdkDropListConnectedTo]="[doneList]"
                    [cdkDropListData]="todo()"
                    class="ingredients-list"
                    (cdkDropListDropped)="drop($event)">
                    @for(item of todo(); track item.idAdcional) {
                        <div class="ingredient-card" cdkDrag [cdkDragData]="item">
                            <div class="ingredient-content">
                                <div class="ingredient-icon">
                                    <img [src]="item.image" [alt]="item.nombre">
                                </div>
                                <div class="ingredient-info">
                                    <h3>{{item.nombre}}</h3>
                                    <span class="price">${{item.precio}}</span>
                                </div>
                            </div>
                            <div class="drag-indicator">‚ãÆ‚ãÆ</div>
                        </div>
                    }
                    @if(todo().length === 0 && currentStep() === 'tortilla') {
                        <div class="empty-message">
                            <p>‚ú® Ya seleccionaste tu tortilla</p>
                        </div>
                    }
                    @if(currentStep() !== 'tortilla') {
                        <div class="info-message">
                            <p>üí° Puedes agregar varios ingredientes de esta categor√≠a</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Columna derecha: Tu Taco + Resumen -->
        <div class="right-column">
            <!-- Panel del taco en construcci√≥n -->
        <div class="taco-panel">
            <div class="panel-header">
                <h2>Tu Taco</h2>
            </div>
            <div
                cdkDropList
                cdkDropListSortingDisabled
                id="doneList"
                #doneList="cdkDropList"
                [cdkDropListConnectedTo]="[todoList]"
                [cdkDropListData]="done()"
                class="taco-list"
                (cdkDropListDropped)="drop($event)">
                @if(done().length === 0) {
                    <div class="empty-taco">
                        <div class="taco-icon">üåÆ</div>
                        <p>Arrastra ingredientes aqu√≠ para comenzar</p>
                        <p class="hint">Empieza con una tortilla</p>
                    </div>
                } @else {
                    <div class="taco-visual-container" [style.min-height.px]="getContainerHeight()">
                        <!-- Ingredientes apilados (sin salsas) -->
                        <div class="taco-stacked-ingredients" [style.height.px]="getStackHeight()">
                            @for(item of done(); track item.idAdcional; let idx = $index) {
                                @if(item.nombre && !item.nombre.toLowerCase().includes('salsa') && !item.nombre.toLowerCase().includes('pico')) {
                                    <div class="stacked-item" 
                                         [class.tortilla-item]="idx === 0"
                                         [class.extra-item]="item.nombre.toLowerCase().includes('queso') || item.nombre.toLowerCase().includes('lechuga')" 
                                         [style.transform]="'translate(-50%, 0) translateY(' + getIngredientTranslateY(item) + 'px)'"
                                         cdkDrag
                                         [cdkDragData]="item">
                                        <img [src]="item.image" [alt]="item.nombre" class="ingredient-image">
                                        <div class="item-label">
                                            <span class="item-name">{{item.nombre}}</span>
                                        </div>
                                        
                                        <!-- Preview personalizado para el drag -->
                                        <div *cdkDragPreview class="drag-preview-custom">
                                            <img [src]="item.image" [alt]="item.nombre" class="preview-image">
                                            <span class="preview-name">{{item.nombre}}</span>
                                        </div>
                                    </div>
                                }
                            }
                        </div>

                        <!-- Salsas en la parte inferior -->
                        @if(getSalsas().length > 0) {
                            <div class="salsas-section">
                                <h3 class="salsas-section-title">Salsas:</h3>
                                <div class="salsas-display">
                                    @for(salsa of getSalsas(); track salsa.idAdcional) {
                                        <div class="salsa-display-item" cdkDrag [cdkDragData]="salsa">
                                            <img [src]="salsa.image" [alt]="salsa.nombre" class="salsa-display-image">
                                            <span class="salsa-display-name">{{salsa.nombre}}</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
            
            <!-- Mensajes de estado -->
            @if(error()) {
                <div class="alert alert-error">
                    {{ error() }}
                </div>
            }
            @if(successMessage()) {
                <div class="alert alert-success">
                    {{ successMessage() }}
                </div>
            }

            @if(done().length > 0) {
                <div class="action-buttons">
                    <button 
                        class="btn-primary" 
                        (click)="agregarAlCarrito()"
                        [disabled]="!puedeAgregarAlCarrito || loading()">
                        @if(loading()) {
                            <span>Agregando...</span>
                        } @else {
                            <span>Agregar al Carrito</span>
                        }
                    </button>
                    <button class="btn-secondary" (click)="clearTaco()" [disabled]="loading()">Limpiar</button>
                    <button class="btn-cancel" (click)="cancelar()" [disabled]="loading()">Cancelar</button>
                </div>
            } @else {
                <div class="action-buttons">
                    <button class="btn-cancel" (click)="cancelar()">Volver a la Tienda</button>
                </div>
            }
        </div>

        <!-- Panel de Resumen -->
        <div class="summary-panel">
            <div class="panel-header">
                <h2>Resumen del Pedido</h2>
                <span class="total-price">Total: ${{totalPrice()}}</span>
            </div>
            <div class="summary-content">
                @if(done().length === 0) {
                    <div class="empty-summary">
                        <p style="color: #ff6b35;">A√∫n no has agregado ingredientes</p>
                    </div>
                } @else {
                    <div class="summary-list">
                        @for(item of done().slice().reverse(); track item.idAdcional) {
                            <div class="summary-item">
                                <span class="summary-item-name">‚Ä¢ {{item.nombre}}</span>
                                <div class="summary-item-actions">
                                    <span class="summary-item-price">${{(item.precio || 0) * (item.cantidad || 1)}}</span>
                                    <button class="btn-remove" (click)="removeItemFromDone(item)" title="Eliminar">
                                        ‚úï
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
    </div>
</div>

<!-- Modal de Confirmaci√≥n: Iniciar Sesi√≥n -->
<div class="modal fade show" tabindex="-1" [style.display]="showLoginModal() ? 'block' : 'none'" *ngIf="showLoginModal()" style="background-color: rgba(0,0,0,0.7);">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; overflow: hidden; border: 2px solid var(--accent-color);">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%); color: white; border: none;">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="bi bi-lock-fill me-2"></i> Inicio de Sesi√≥n Requerido
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="cerrarModalLogin()"></button>
            </div>
            <div class="modal-body" style="padding: 2rem; background-color: rgba(45, 21, 41, 0.95);">
                <div class="text-center py-3">
                    <i class="bi bi-person-circle" style="font-size: 4rem; color: var(--accent-color);"></i>
                    <h4 class="mt-3 mb-3" style="color: white;">¬øIniciar Sesi√≥n?</h4>
                    <p class="text-muted mb-3">
                        Necesitas iniciar sesi√≥n para agregar productos al carrito y realizar tu pedido.
                    </p>
                    <div class="alert" style="background: rgba(237, 126, 71, 0.1); border: 2px solid var(--accent-color); color: var(--accent-color); text-align: left;">
                        <i class="bi bi-info-circle me-2"></i> 
                        Tu taco personalizado se guardar√° y podr√°s continuar despu√©s de iniciar sesi√≥n.
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="background-color: rgba(45, 21, 41, 0.95); border-top: 1px solid rgba(237, 126, 71, 0.3); padding: 1.5rem;">
                <button type="button" class="btn btn-secondary" (click)="cerrarModalLogin()" style="padding: 0.7rem 1.5rem; border-radius: 10px; font-weight: 600;">
                    <i class="bi bi-x-lg me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" (click)="irALogin()" style="background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-hover) 100%); border: none; padding: 0.7rem 1.5rem; border-radius: 10px; font-weight: 600; box-shadow: 0 4px 15px rgba(237, 126, 71, 0.4);">
                    <i class="bi bi-box-arrow-in-right me-1"></i> Iniciar Sesi√≥n
                </button>
            </div>
        </div>
    </div>
</div>
